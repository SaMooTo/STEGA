#include <vcl.h>
#pragma hdrstop

#include "uMAIN.h"
//---------------------------------------------------------------------------
#pragma package(smart_init)
#pragma resource "*.dfm"
using namespace std;
TForm1 *Form1;
//Пользовательские переменные|Начало
TBitmap *Bmp;
int R,G,B;
int WIDTH, HEIGHT;
struct pnt {
	int x=0;
	int y=0;
};
//Пользовательские переменные|Конец

//Пользовательские функции|Начало
BYTE GetBit(BYTE B, int N) {
	if ((1 << N) & B) return 1;
	return 0;
}

BYTE ChangeByte(BYTE B, int bit) {
	if (GetBit(B, 0) == bit) return B;
	else if (GetBit(B, 0) == 1 && bit == 0) return B-1;
	else if (GetBit(B, 0) == 0 && bit == 1) return B|bit;
	return NULL;
}

pnt NextPos(pnt p, int Step, int WIDTH) {
    if (p.x + Step > (WIDTH-1)) {
		while (p.x + Step > (WIDTH-1)) {
			p.y++;
			Step = Step - WIDTH;
		}
	}
	p.x = p.x + Step;
	return p;
}
//Пользовательские функции|Конец
//---------------------------------------------------------------------------
__fastcall TForm1::TForm1(TComponent* Owner)
	: TForm(Owner)
{
}
//---------------------------------------------------------------------------
void __fastcall TForm1::CODEClick(TObject *Sender)
{
	if (OpenPath->Text != "") {
		IMG->Picture->LoadFromFile(OpenDialog->FileName);
		Bmp = IMG->Picture->Bitmap;
		Bmp->PixelFormat = pf24bit;
		WIDTH = Bmp->Width;
		HEIGHT = Bmp->Height;
	}
	pnt p;
	p.y = 0; p.x = 0;
	AnsiString Text = MEMO->Text;
	int Step = WIDTH * HEIGHT / Text.Length() / 8;
	for (int i = 1; i < Text.Length()+1; i++) {
		char c = Text[i];
		for (int j = 0; j < 8; j++) {
			int bit = GetBit(c, 7-j);
			TColor Color = Bmp->Canvas->Pixels[p.x][p.y];
			R = GetRValue(Color);
			G = GetGValue(Color);
			B = GetBValue(Color);
			R = ChangeByte(R, bit);
			Bmp->Canvas->Pixels[p.x][p.y] = (TColor) RGB(R,G,B);
			p = NextPos(p, Step, WIDTH);
		}
	}
	ShowMessage("Шаг: " + IntToStr(Step) + "\n" + "Длина текст: " + IntToStr(Text.Length()));
	MEMO->Text = "";
	STEP->Text = "";
}
//---------------------------------------------------------------------------
void __fastcall TForm1::DECODEClick(TObject *Sender)
{
	if (LEN->Text != "" && STEP->Text != "") {
    	int key = StrToInt(LEN->Text);
		pnt p;
		p.x = 0; p.y = 0;
		string sbuf = "";
		for (int i = 1; i < key+1; i++) {
			int ibuf = 0;
			for (int j = 0; j < 8; j++) {
				TColor Color = Bmp->Canvas->Pixels[p.x][p.y];
				R = GetRValue(Color);
				ibuf = ibuf + GetBit(R, 0) * pow(2, 7-j);
				p = NextPos(p, StrToInt(STEP->Text), WIDTH);
			}
			sbuf = sbuf + (char)ibuf;
		}
		MEMO->Text = sbuf.c_str();
	} else {ShowMessage("Заполните поля ввода!");}
}
//---------------------------------------------------------------------------
void __fastcall TForm1::OPENClick(TObject *Sender)
{
	if (OpenDialog->Execute()){
		OpenPath->Text = OpenDialog->FileName;
		IMG->Picture->LoadFromFile(OpenDialog->FileName);
		Bmp = IMG->Picture->Bitmap;
		Bmp->PixelFormat = pf24bit;
		WIDTH = Bmp->Width;
		HEIGHT = Bmp->Height;
	}
}
//---------------------------------------------------------------------------
void __fastcall TForm1::SAVEClick(TObject *Sender)
{
	if (SaveDialog->Execute()) {
		IMG->Picture->SaveToFile(SaveDialog->FileName);
	}
}
//---------------------------------------------------------------------------
